#
# id[] = @(#) $Id$
#
#  Author: Nicholas Cardo
#          Centro Svizzero di Calcolo Scientifico
#          Swiss National Supercomputing Centre
#
#  ~~~~~~~~~~~~~~~~~~~~
#  Modification History
#  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#  Date       Who             What
#  ---------- --------------- -------------------------------------------------
#  04/09/2015 N. Cardo        Original Makefile, autogenerated.
#  ---------- --------------- -------------------------------------------------

#
#  Execute owner and permissions
#
EMODE  = 550
EOWNER = bin
EGROUP = csstaff

#
#  Read-Only owner and permissions
#
RMODE  = 440
ROWNER = bin
RGROUP = csstaff

#
#  Install Directories
#
PREFIX  := $(shell dirname `pwd`)
VERSION := $(shell basename ${PREFIX})
BIN      = $(PREFIX)/bin
MAN      = $(PREFIX)/man
CAT1     = $(MAN)/cat1
CAT5     = $(MAN)/cat5
CAT7     = $(MAN)/cat7
ETC      = $(PREFIX)/etc
INC      = $(PREFIX)/include
LIB      = $(PREFIX)/lib
CFG      = $(PREFIX)/etc/monthlyrpts.conf

#
#  Common Makefile Commands
#
CC      = /usr/bin/gcc 
CMP     = /usr/bin/cmp
CP      = /bin/cp
INSTALL = /usr/bin/install -D -C
LN      = /bin/ln
NROFF   = /usr/bin/nroff -man
RM      = /bin/rm

OBJS = perfrpts.o dbops.o usage.o ReportDir.o JobProfileRpt.o LargeMemSubmitCountsRpt.o LargeMemStartCountsRpt.o LargeMemEndCountsRpt.o EndCountsRpt.o StartCountsRpt.o SubmitCountsRpt.o UZHQueueWaitRpt.o QueueWaitRpt.o UZHUtilizationRpt.o UtilizationRpt.o GetJobs.o GetProjects.o AllocationRpt.o AvailabilityRpt.o UZHTimeRpt.o rdconfig.o HoursInMonth.o

#
#  do the same for mysql
#
have_mysqlconfig := $(shell (which mysql_config 2> /dev/null))
ifneq ($(strip $(have_mysqlconfig)),)
	MYSQL_H = $(shell mysql_config --cflags)
	MYSQL_L = $(shell mysql_config --libs)
else
$(error mysql_config (libmysqlclient-devel) not installed)
endif

MYSQL=$(MYSQL_H)
#
# REPORTROOT is the base directory for generated data and plots
# PLOTDIR is the directory containing the ploticus files
# UZHPROJECTCOUNT is the number of UZH projects in the fair share hierarchy under uzhp
#
OPTIONS = -DREPORTROOT=\"${PREFIX}/reports\"  -DPLOTDIR=\"${PREFIX}/plots\" -DROOTDIR=\"${PREFIX}\" -DUZHPROJECTCOUNT=21 -DCONFIGFILE=\"${CFG}\"

CFLAGS= 
LDFLAGS=$(MYSQL_L) -lpthread -ldl

CMDS=perfrpts crevent outagerpt
MAN1P=perfrpts.1 crevent.1 outagerpt.1
MAN5P=Availability.dat.5 EndCounts.dat.5 StartCounts.dat.5 SubmitCounts.dat.5 JobProfile.dat.5 QueueWait.dat.5 Utilization.dat.5
MAN7P=monthlyrpts.7

build: $(CMDS) $(MAN1P) $(MAN5P) $(MAN7P) modulefile

crevent: crevent.bash
	$(CP) $@.bash $@

outagerpt: outagerpt.bash
	$(CP) $@.bash $@

perfrpts: $(OBJS)
	$(CC) -o $@ $(OBJS) $(LDFLAGS)

perfrpts.o: perfrpts.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

dbops.o: dbops.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) $(MYSQL) ${@:.o=.c}

ReportDir.o: ReportDir.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) $(MYSQL) ${@:.o=.c}

GetJobs.o: GetJobs.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

GetProjects.o: GetProjects.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

AllocationRpt.o: AllocationRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

AvailabilityRpt.o: AvailabilityRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

JobProfileRpt.o: JobProfileRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

LargeMemSubmitCountsRpt.o: LargeMemSubmitCountsRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

LargeMemStartCountsRpt.o: LargeMemStartCountsRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

LargeMemEndCountsRpt.o: LargeMemEndCountsRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

EndCountsRpt.o: StartCountsRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

StartCountsRpt.o: StartCountsRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

SubmitCountsRpt.o: SubmitCountsRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

QueueWaitRpt.o: QueueWaitRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

UZHQueueWaitRpt.o: UZHQueueWaitRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

UZHTimeRpt.o: UZHTimeRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

UtilizationRpt.o: UtilizationRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

UZHUtilizationRpt.o: UZHUtilizationRpt.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

rdconfig.o: rdconfig.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

HoursInMonth.o: HoursInMonth.c perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

usage.o: usage.c version.h perfrpts.h
	$(CC) -c $(CFLAGS) $(OPTIONS) ${@:.o=.c}

%.1: %.man1
	$(NROFF) $(@:.1=.man1) > $@

%.5: %.man5
	$(NROFF) $(@:.5=.man5) > $@

%.7: %.man7
	$(NROFF) $(@:.7=.man7) > $@

modulefile: Makefile
	echo "#%Module"                                                 >  ModuleFile
	echo ""                                                         >> ModuleFile
	echo "module-whatis \"Setup monthlyrpts paths and environemnt"  >> ModuleFile
	echo "variables for use.\""                                     >> ModuleFile
	echo ""                                                         >> ModuleFile
	echo "proc ModulesHelp { } {"                                   >> ModuleFile
	echo "    puts stderr \"Adds monthlyrpts to the search path.\"" >> ModuleFile
	echo "    puts stderr \"\""                                     >> ModuleFile
	echo "}"                                                        >> ModuleFile
	echo ""                                                         >> ModuleFile
	echo "set  VERSION            $(VERSION)"                       >> ModuleFile
	echo "set  MONTHLYRPTS_ROOT   $(PREFIX)"                        >> ModuleFile
	echo "set  MONTHLYRPTS_RPTS   $(PREFIX)/reports"                >> ModuleFile
	echo "set  MONTHLYRPTS_PLOTS  $(PREFIX)/plots"                  >> ModuleFile
	echo ""                                                         >> ModuleFile
	echo "append-path     PATH  $(BIN)"                             >> ModuleFile
	echo "append-path  MANPATH  $(MAN)"                             >> ModuleFile
	echo ""                                                         >> ModuleFile
	echo "setenv  MONTHLYRPTS_ROOT   $(PREFIX)"                     >> ModuleFile
	echo "setenv  MONTHLYRPTS_RPTS   $(PREFIX)/reports"             >> ModuleFile
	echo "setenv  MONTHLYRPTS_PLOTS  $(PREFIX)/plots"               >> ModuleFile
	echo ""                                                         >> ModuleFile 

install:
	for mp in $(CMDS); do \
		$(INSTALL) -m $(EMODE) $$mp $(BIN)/$$mp; \
	done

	for mp in $(MAN1P); do \
		$(INSTALL) -C -m $(RMODE) $$mp $(CAT1)/$$mp; \
	done

	for mp in $(MAN5P); do \
		$(INSTALL) -C -m $(RMODE) $$mp $(CAT5)/$$mp; \
	done

	for mp in $(MAN7P); do \
		$(INSTALL) -C -m $(RMODE) $$mp $(CAT7)/$$mp; \
	done

#uninstall:
#	- $(RM) -f $(BIN)/crrpt $(CAT)/crrpt.8 
#
clean:
	- $(RM) -f perfrpts crevent outagerpt $(OBJS) $(MAN1P) $(MAN5P) $(MAN7P)

